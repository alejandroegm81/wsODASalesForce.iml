<?xml version="1.0" encoding="ISO-8859-1"?>
<root>
    <query_cliente  ><![CDATA[
                    select
                    row_number() over ( partition by customer_id order by customer_id, ohduedate desc) No,
                    datos.customer_id, datos.co_id, datos.dn_num, datos.nombre, datos.identificacion, datos.tipo_cliente, datos.correo,
                    sum(nvl(saldoNoVencido,0)+nvl(saldovencido,0)) over ( partition by customer_id order by customer_id) saldo_total,
                    sum(saldoNoVencido) over ( partition by customer_id order by customer_id) saldo_novencido,
                    sum(saldovencido) over ( partition by customer_id order by customer_id) saldo_vencido,
                    count(*) over ( partition by customer_id order by customer_id) cantidad_documentos,
                    datos.id2, datos.docid, datos.doc, datos.refe, datos.npe, datos.lectura, datos.factura, datos.emision, datos.vencimiento, datos.diasmora, datos.saldo, datos.saldovencido, datos.saldoNovencido, datos.ohduedate, ciclo
                    from (
                        select /*+RULE*/
                            --IDNPE, row_number() over ( partition by ncli, npe order by  ncli ) NumFacturaVencida,
                            codigo_cliente CUSTOMER_ID,  numtel  CO_ID, telefono  DN_NUM, nombre, dui IDENTIFICACION, '' tipo_cliente,
                            CorreoElectronico correo,
                            nvl(sum(case when saldo_actual>0 then saldo_actual end),0)                         Saldo_total,
                            nvl(sum(case when fecha_venc<trunc(sysdate) then saldo_actual end),0)               Saldo_Vencido,
                            nvl(count(*) -1 ,0)                                                                Cantidad_Documentos ,
                            codigo_cliente          id2,
                            referencia              docid,
                            TELEFONO                doc,
                            referencia              refe,
                            npe,
                            0                       Lectura,
                            CASE WHEN nech is not null then 'FI' when nfact is not null then 'FA' end Factura,
                            to_char(Fecha_Emi,'dd/MM/yyyy')        Emision,
                            to_char(Fecha_Venc,'dd/MM/yyyy')       Vencimiento,
                            nvl(Round((trunc(sysdate) - Fecha_Venc),0),0)  diasMora,
                            nvl(sum(case when saldo_actual>0 then saldo_actual end),0)  Saldo,
                            nvl(sum(case when Fecha_Venc>=trunc(sysdate) then saldo_actual end ),0)SaldoNoVencido,
                            nvl(sum(case when Fecha_Venc<trunc(sysdate) then saldo_actual end ),0)SaldoVencido,
                            Fecha_Venc ohduedate, ciclo_cliente ciclo
                        from
                        (
                        select  c.ncli codigo_cliente,
                                Replace(Concat(c.nom,Concat(', ',Concat(c.prenom1,Concat(' ',c.prenom2)))),'''') nombre,
                                replace(concat( rtrim(pc.lcom), concat( ',  ', concat( rtrim(nvl(pq.lquartier, ' ')), concat( ',  ', concat(  nvl( decode( pv.cvoie, 'XXXX', rtrim(a.lvoie), rtrim(pv.lvoie)), ' '), concat( '  ', concat( a.nvoie, concat( ', ', rtrim(a.compl_adr) ) ) ) ) ) ) ) ),'''') Direccion,
                                replace(rtrim(pc.lcom) , '''') as municipio,
                                cons1.nd     telefono,
                                decode (c.type_ident,'7',c.nregc,'')     Num_Reg,
                                decode (c.type_ident,'8',c.nregc,'') DUI, d.groupe_fact ciclo_cliente,
                                cons1.ndos,d.cprod , NVL(d.rfiscal,1) ClienteExento ,
                                (select max(trim(lcontact)) from contact_client@girafe c0 where  c0.ncli=c.ncli and ncontact=2 ) CorreoElectronico
                        from dossier@GIRAFE d, client@GIRAFE c, adresse@GIRAFE a, p_commune@GIRAFE pc, p_quartier@GIRAFE pq, p_voie@GIRAFE pv,
                             (   select d0.ncli Num_cli, min(d0.nd) nd, ndos from doslig0@GIRAFE d0 where d0.ncli={CLIENTE} and datfin_ld is null group by d0.ncli,ndos ) cons1
                        where c.ncli = cons1.num_cli and a.ncli = c.ncli and a.nadr = c.nadr_cli and a.datfin is null and a.ccom = pc.ccom(+) and a.ccom = pq.ccom(+) and a.cquartier = pq.cquartier(+) and a.ccom = pv.ccom(+) and a.cquartier = pv.cquartier(+) and a.cvoie = pv.cvoie(+) and c.ncli = d.ncli(+) and d.ndos=cons1.ndos
                        ) DataCliente left outer join
                        (
                            select ncli, an_fact, per_fact, groupe_fact, nfact, nech, nremb_ech, IDNPE, npe, monto_facturacion, operador, referencia, numtel, fecha_emi,fecha_venc, saldo_actual, diferencia_fechas, ciclo , ndos, cprod
                            from (
                                select  f.ncli,
                                        f.an_fact,  f.per_fact, f.groupe_fact, f.nfact,
                                        n.nech, n.nremb_ech,
                                        N.npe, N_.monto_facturacion, IDNPE,
                                        555 Operador,
                                        to_char(f.an_fact,'FM9')|| to_char(f.per_fact,'FM09') || f.groupe_fact || to_char(f.nfact,'FM000009') Referencia,
                                        he.nd numtel,
                                        trunc(f.dateM_fact)  Fecha_Emi, --to_char(f.datech_fact,'dd/MM/yyyy') Fecha_Venc,
                                        trunc(f.datech_fact) Fecha_Venc, --to_char(f.datech_fact,'dd/MM/yyyy') Fecha_Venc,
                                        round(f.mnt_solde_fact - ( select nvl(sum(e.mnt_lettr),0)
                                           from encaissement@GIRAFE e         where e.ncli=f.ncli             and e.ndos_cprod=f.ndos         and e.an_fact=f.an_fact         and e.per_fact=f.per_fact
                                           and e.groupe_fact=f.groupe_fact         and e.nfact_nech=f.nfact        and e.mod_lettr='B'     and e.etat_enc in ('1','2')
                                           and e.n_souscpte='1'        and e.cpai not in ('A','B','C','D','E','F','G','H','I','J')             ),2)       Saldo_Actual,
                                        (trunc(sysdate) - f.datech_fact) diferencia_fechas, f.groupe_fact CICLO, f.ndos, f.cprod
                                from h_expedition@GIRAFE he
                                    inner join  facture@GIRAFE f     on he.ncli=f.ncli and he.an_fact=f.an_fact and he.per_fact=f.per_fact and he.groupe_fact=f.groupe_fact and he.nfact=f.nfact
                                    inner join  t_seq_npe@GIRAFE n   on he.ncli=n.ncli and he.an_fact=n.an_fact and he.per_fact=n.per_fact and he.groupe_fact=n.groupe_fact and he.nfact=n.nfact
                                    inner join ( select ncli, npe, datech, monto_facturacion, row_number() over ( order by a.datech desc) IDNPE from ( SELECT  a.ncli, npe, max(datech) datech, sum(round(mnt_solde,2)) Monto_facturacion FROM client@GIRAFE a inner join t_seq_npe@GIRAFE b on a.ncli=b.ncli and a.ncli= {CLIENTE} group by a.ncli, npe ) a ) N_ on n.ncli=N_.ncli and n.npe=N_.npe
                                where   he.ncli= {CLIENTE} and npe0 is not null
                                union all
                                select e.ncli, n.an_fact, n.per_fact, n.groupe_fact, n.nfact,
                                        n.nech, n.nremb_ech,
                                        N.npe, N_.monto_facturacion, IDNPE,
                                        210 Operador,
                                        to_char(e.nech,'FM009') || '-' || to_char(e.nremb_ech,'FM09') Num_Fin,
                                        ' 'numTel,
                                        trunc(e.datpai_ech)  Fecha_Emi, --to_char(f.datech_fact,'dd/MM/yyyy') Fecha_Venc,
                                        trunc(e.datpai_ech) FechaCuota,--to_char(e.datpai_ech,'dd/mm/yyyy') Fecha_Cuota,
                                        round(e.mnt_solde_ech-(select nvl(sum(enc.mnt_lettr),0)
                                                       from encaissement@GIRAFE enc
                                                   where enc.ncli=e.ncli
                                                    and enc.an_fact is null               and enc.per_fact is null
                                                     and enc.groupe_fact is null           and enc.nfact_nech=e.nech
                                                     and enc.ndem_nremb=e.nremb_ech        and enc.mod_lettr='B'
                                                     and enc.etat_enc in ('1','2')     and enc.n_souscpte='5'
                                                     and enc.cpai not in ('A','B','C','D','E','F','G','H','I','J')
                                                       ),2) Saldo_Actual	,
                                        trunc(sysdate) - e.datpai_ech  diferencia_fechas    , Ciclo , ndos, cprod
                                from echeances@GIRAFE e
                                    left outer join ( select a0.ncli, a0.nech, a0.groupe_fact tipo_fact, max(b0.groupe_fact) ciclo,cprod from ech_fact@GIRAFE a0 inner join dossier@GIRAFE b0 on a0.ncli=b0.ncli and a0.ndos=b0.ndos and a0.ncli = {CLIENTE} group by a0.ncli, a0.nech, a0.groupe_fact, cprod ) f on e.ncli=f.ncli and e.nech=f.nech
                                    inner join  t_seq_npe@GIRAFE n   on e.ncli=n.ncli and e.nech=n.nech and e.nremb_ech=n.nremb_ech
                                    inner join ( select ncli, npe, datech, monto_facturacion, row_number() over ( order by a.datech desc) IDNPE from ( SELECT  a.ncli, npe, max(datech) datech, sum(round(mnt_solde,2)) monto_facturacion FROM client@GIRAFE a inner join t_seq_npe@GIRAFE b on a.ncli=b.ncli and a.ncli= {CLIENTE} group by a.ncli, npe ) a ) N_ on n.ncli=N_.ncli and n.npe=N_.npe
                                where   e.ncli= {CLIENTE} and npe0 is not null
                            ) where saldo_actual>0
                        ) facturas on facturas.ncli = DataCliente.codigo_cliente  and facturas.ndos = DataCliente.ndos
                        group by
                            codigo_cliente ,  numtel  , telefono  , nombre, dui ,
                            referencia              ,
                            npe,
                            CASE WHEN nech is not null then 'FI' when nfact is not null then 'FA' end ,
                            to_char(Fecha_Emi,'dd/MM/yyyy')        ,
                            to_char(Fecha_Venc,'dd/MM/yyyy')       ,
                            nvl(Round((trunc(sysdate) - Fecha_Venc),0),0)  ,
                            Fecha_Venc, ciclo,CorreoElectronico, ciclo_cliente
                        ) datos
                        order by nvl(factura,'FE') ASC, to_date(vencimiento,'dd/MM/yyyy') asc
    ]]></query_cliente>




    <query_telefono><![CDATA[
                    select
                    row_number() over ( partition by customer_id order by customer_id, ohduedate desc) No,
                    datos.customer_id, datos.co_id,
                    max(decode(datos.dn_num,{TELEFONO},datos.dn_num)) over ( partition by customer_id order by customer_id, ohduedate desc) DN_NUM,
                    datos.nombre, datos.identificacion, datos.tipo_cliente, datos.correo,
                    sum(nvl(saldoNoVencido,0)+nvl(saldovencido,0)) over ( partition by customer_id order by customer_id) saldo_total,
                    sum(saldoNoVencido) over ( partition by customer_id order by customer_id) saldo_novencido,
                    sum(saldovencido) over ( partition by customer_id order by customer_id) saldo_vencido,
                    count(*) over ( partition by customer_id order by customer_id) cantidad_documentos,
                    datos.id2, datos.docid, datos.doc, datos.refe, datos.npe, datos.lectura, datos.factura, datos.emision, datos.vencimiento, datos.diasmora, datos.saldo, datos.saldovencido,datos.saldoNovencido,  datos.ohduedate, ciclo
                    from (
                        select /*+RULE*/
                            --IDNPE, row_number() over ( partition by ncli, npe order by  ncli ) NumFacturaVencida,
                            codigo_cliente CUSTOMER_ID,  numtel  CO_ID, telefono  DN_NUM, nombre, dui IDENTIFICACION, '' tipo_cliente, CorreoElectronico correo,
                            nvl(sum(case when saldo_actual>0 then saldo_actual end),0)                         Saldo_total,
                            nvl(sum(case when fecha_venc<trunc(sysdate) then saldo_actual end),0)               Saldo_Vencido,
                            nvl(count(*) -1 ,0)                                                                Cantidad_Documentos ,
                            codigo_cliente          id2,
                            referencia              docid,
                            TELEFONO                doc,
                            referencia              refe,
                            npe,
                            0                       Lectura,
                            CASE WHEN nech is not null then 'FI' when nfact is not null then 'FA' end Factura,
                            to_char(Fecha_Emi,'dd/MM/yyyy')        Emision,
                            to_char(Fecha_Venc,'dd/MM/yyyy')       Vencimiento,
                            nvl(Round((trunc(sysdate) - Fecha_Venc),0),0)  diasMora,
                            nvl(sum(case when saldo_actual>0 then saldo_actual end),0)  Saldo,
                            nvl(sum(case when Fecha_Venc>=trunc(sysdate) then saldo_actual end ),0)SaldoNoVencido,
                            nvl(sum(case when Fecha_Venc<trunc(sysdate) then saldo_actual end ),0)SaldoVencido,
                            Fecha_Venc ohduedate, ciclo_cliente ciclo
                        from
                        (
                        select  c.ncli codigo_cliente,
                                Replace(Concat(c.nom,Concat(', ',Concat(c.prenom1,Concat(' ',c.prenom2)))),'''') nombre,
                                replace(concat( rtrim(pc.lcom), concat( ',  ', concat( rtrim(nvl(pq.lquartier, ' ')), concat( ',  ', concat(  nvl( decode( pv.cvoie, 'XXXX', rtrim(a.lvoie), rtrim(pv.lvoie)), ' '), concat( '  ', concat( a.nvoie, concat( ', ', rtrim(a.compl_adr) ) ) ) ) ) ) ) ),'''') Direccion,
                                replace(rtrim(pc.lcom) , '''') as municipio,
                                cons1.nd     telefono,
                                decode (c.type_ident,'7',c.nregc,'')     Num_Reg,
                                decode (c.type_ident,'8',c.nregc,'') DUI, d.groupe_fact ciclo_cliente,
                                cons1.ndos,d.cprod , NVL(d.rfiscal,1) ClienteExento,
                                (select max(trim(lcontact)) from contact_client@girafe c0 where  c0.ncli=c.ncli and ncontact=2 ) CorreoElectronico
                        from dossier@GIRAFE d, client@GIRAFE c, adresse@GIRAFE a, p_commune@GIRAFE pc, p_quartier@GIRAFE pq, p_voie@GIRAFE pv,
                             (   select d0.ncli Num_cli, min(d0.nd) nd, ndos from doslig0@GIRAFE d0 where d0.ncli IN ( select d0.ncli Num_cli from doslig0@GIRAFE d0 where d0.nd={TELEFONO} and datfin_ld is null group by d0.ncli)  group by d0.ncli,ndos ) cons1
                        where c.ncli = cons1.num_cli and a.ncli = c.ncli and a.nadr = c.nadr_cli and a.datfin is null and a.ccom = pc.ccom(+) and a.ccom = pq.ccom(+) and a.cquartier = pq.cquartier(+) and a.ccom = pv.ccom(+) and a.cquartier = pv.cquartier(+) and a.cvoie = pv.cvoie(+) and c.ncli = d.ncli(+) and d.ndos=cons1.ndos
                        ) DataCliente left outer join
                        (
                            select ncli, an_fact, per_fact, groupe_fact, nfact, nech, nremb_ech, IDNPE, npe, monto_facturacion, operador, referencia, numtel, fecha_emi,fecha_venc, saldo_actual, diferencia_fechas, ciclo , ndos, cprod
                            from (
                                select  f.ncli,
                                        f.an_fact,  f.per_fact, f.groupe_fact, f.nfact,
                                        n.nech, n.nremb_ech,
                                        N.npe, N_.monto_facturacion, IDNPE,
                                        555 Operador,
                                        to_char(f.an_fact,'FM9')|| to_char(f.per_fact,'FM09') || f.groupe_fact || to_char(f.nfact,'FM000009') Referencia,
                                        he.nd numtel,
                                        trunc(f.dateM_fact)  Fecha_Emi, --to_char(f.datech_fact,'dd/MM/yyyy') Fecha_Venc,
                                        trunc(f.datech_fact) Fecha_Venc, --to_char(f.datech_fact,'dd/MM/yyyy') Fecha_Venc,
                                        round(f.mnt_solde_fact - ( select nvl(sum(e.mnt_lettr),0)
                                           from encaissement@GIRAFE e         where e.ncli=f.ncli             and e.ndos_cprod=f.ndos         and e.an_fact=f.an_fact         and e.per_fact=f.per_fact
                                           and e.groupe_fact=f.groupe_fact         and e.nfact_nech=f.nfact        and e.mod_lettr='B'     and e.etat_enc in ('1','2')
                                           and e.n_souscpte='1'        and e.cpai not in ('A','B','C','D','E','F','G','H','I','J')             ),2)       Saldo_Actual,
                                        (trunc(sysdate) - f.datech_fact) diferencia_fechas, f.groupe_fact CICLO, f.ndos, f.cprod
                                from h_expedition@GIRAFE he
                                    inner join  facture@GIRAFE f     on he.ncli=f.ncli and he.an_fact=f.an_fact and he.per_fact=f.per_fact and he.groupe_fact=f.groupe_fact and he.nfact=f.nfact
                                    inner join  t_seq_npe@GIRAFE n   on he.ncli=n.ncli and he.an_fact=n.an_fact and he.per_fact=n.per_fact and he.groupe_fact=n.groupe_fact and he.nfact=n.nfact
                                    inner join ( select ncli, npe, datech, monto_facturacion, row_number() over ( order by a.datech desc) IDNPE from ( SELECT  a.ncli, npe, max(datech) datech, sum(round(mnt_solde,2)) Monto_facturacion FROM client@GIRAFE a inner join t_seq_npe@GIRAFE b on a.ncli=b.ncli and a.ncli in (select d0.ncli Num_cli from doslig0@GIRAFE d0 where d0.nd={TELEFONO} and datfin_ld is null group by d0.ncli) group by a.ncli, npe ) a ) N_ on n.ncli=N_.ncli and n.npe=N_.npe
                                where   he.ncli in (select d0.ncli Num_cli from doslig0@GIRAFE d0 where d0.nd={TELEFONO} and datfin_ld is null group by d0.ncli) and npe0 is not null
                                union all
                                select e.ncli, n.an_fact, n.per_fact, n.groupe_fact, n.nfact,
                                        n.nech, n.nremb_ech,
                                        N.npe, N_.monto_facturacion, IDNPE,
                                        210 Operador,
                                        to_char(e.nech,'FM009') || '-' || to_char(e.nremb_ech,'FM09') Num_Fin,
                                        ' 'numTel,
                                        trunc(e.datpai_ech)  Fecha_Emi, --to_char(f.datech_fact,'dd/MM/yyyy') Fecha_Venc,
                                        trunc(e.datpai_ech) FechaCuota,--to_char(e.datpai_ech,'dd/mm/yyyy') Fecha_Cuota,
                                        round(e.mnt_solde_ech-(select nvl(sum(enc.mnt_lettr),0)
                                                       from encaissement@GIRAFE enc
                                                   where enc.ncli=e.ncli
                                                    and enc.an_fact is null               and enc.per_fact is null
                                                     and enc.groupe_fact is null           and enc.nfact_nech=e.nech
                                                     and enc.ndem_nremb=e.nremb_ech        and enc.mod_lettr='B'
                                                     and enc.etat_enc in ('1','2')     and enc.n_souscpte='5'
                                                     and enc.cpai not in ('A','B','C','D','E','F','G','H','I','J')
                                                       ),2) Saldo_Actual	,
                                        trunc(sysdate) - e.datpai_ech  diferencia_fechas    , Ciclo , ndos, cprod
                                from echeances@GIRAFE e
                                    left outer join ( select a0.ncli, a0.nech, a0.groupe_fact tipo_fact, max(b0.groupe_fact) ciclo,cprod from ech_fact@GIRAFE a0 inner join dossier@GIRAFE b0 on a0.ncli=b0.ncli and a0.ndos=b0.ndos and a0.ncli in (select d0.ncli Num_cli from doslig0@GIRAFE d0 where d0.nd={TELEFONO} and datfin_ld is null group by d0.ncli) group by a0.ncli, a0.nech, a0.groupe_fact, cprod ) f on e.ncli=f.ncli and e.nech=f.nech
                                    inner join  t_seq_npe@GIRAFE n   on e.ncli=n.ncli and e.nech=n.nech and e.nremb_ech=n.nremb_ech
                                    inner join ( select ncli, npe, datech, monto_facturacion, row_number() over ( order by a.datech desc) IDNPE from ( SELECT  a.ncli, npe, max(datech) datech, sum(round(mnt_solde,2)) monto_facturacion FROM client@GIRAFE a inner join t_seq_npe@GIRAFE b on a.ncli=b.ncli and a.ncli IN (select d0.ncli Num_cli from doslig0@GIRAFE d0 where d0.nd={TELEFONO} and datfin_ld is null group by d0.ncli) group by a.ncli, npe ) a ) N_ on n.ncli=N_.ncli and n.npe=N_.npe
                                where   e.ncli IN ( select d0.ncli Num_cli from doslig0@GIRAFE d0 where d0.nd={TELEFONO}  group by d0.ncli ) and npe0 is not null
                            ) where saldo_actual>0
                        ) facturas on facturas.ncli = DataCliente.codigo_cliente  and facturas.ndos = DataCliente.ndos
                        group by
                            codigo_cliente ,  numtel  , telefono  , nombre, dui ,
                            referencia              ,
                            npe,
                            CASE WHEN nech is not null then 'FI' when nfact is not null then 'FA' end ,
                            to_char(Fecha_Emi,'dd/MM/yyyy')        ,
                            to_char(Fecha_Venc,'dd/MM/yyyy')       ,
                            nvl(Round((trunc(sysdate) - Fecha_Venc),0),0)  ,
                            Fecha_Venc, ciclo, CorreoElectronico, ciclo_cliente
                        ) datos
                        order by nvl(factura,'FE') ASC, to_date(vencimiento,'dd/MM/yyyy') asc
    ]]></query_telefono>

</root>