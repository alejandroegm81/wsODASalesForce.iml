<?xml version="1.0" encoding="ISO-8859-1"?>
<root>
    <query_cliente  ><![CDATA[
                select
                    row_number() over ( partition by customer_id order by customer_id, ohduedate desc) No,
                    datos.customer_id, datos.co_id, datos.dn_num, datos.nombre, datos.identificacion, datos.tipo_cliente, datos.correo,
                    sum(nvl(saldoNoVencido,0)+nvl(saldovencido,0)) over ( partition by customer_id order by customer_id) saldo_total,
                    sum(saldoNoVencido) over ( partition by customer_id order by customer_id) saldo_novencido,
                    sum(saldovencido) over ( partition by customer_id order by customer_id) saldo_vencido,
                    count(*) over ( partition by customer_id order by customer_id) cantidad_documentos,
                    datos.id2, datos.docid, datos.doc, datos.refe, datos.npe, datos.lectura, datos.factura, datos.emision, datos.vencimiento, datos.diasmora, datos.saldo, datos.saldovencido, datos.saldoNovencido, datos.ohduedate,
                    vciclofact ciclo
                    from (
                        SELECT
                              telefono customer_id           ,
                              '' co_id                 ,
                              substr(telefono,3,8) dn_num                ,
                              nombre                         ,
                              '' Identificacion                 ,
                              '' Tipo_Cliente,
                              '' Correo,
                              nvl(sum(case when ROUND (saldo / 100, 2)>0 then ROUND (saldo / 100, 2) end),0)                 Saldo_total,
                              nvl(sum(case when to_date(vencimiento,'yyyymmdd')<trunc(sysdate) then ROUND (saldo / 100, 2) end),0)    Saldo_Vencido,
                              nvl(count(*) -1 ,0)                                                  Cantidad_Documentos ,
                              telefono              id2,
                              ''                 docid,
                              ''                    doc,
                              telefono        refe,
                              ''                    npe,
                              0                     Lectura,
                              'FA'                  Factura,
                              to_char(to_date(fecha,'yyyymmdd'),'dd/MM/yyyy')             Emision,
                              to_char(to_date(vencimiento,'yyyymmdd'),'dd/MM/yyyy')                   Vencimiento,
                              nvl(Round((trunc(sysdate) - to_date(vencimiento,'yyyymmdd')),0),0)      diasMora,
                              nvl(sum(case when ROUND (saldo / 100, 2)>0 then ROUND (saldo / 100, 2) end),0)  Saldo,
                              nvl(sum(case when to_date(vencimiento,'yyyymmdd')>=trunc(sysdate) then ROUND (saldo / 100, 2) end ),0)SaldoNoVencido,
                              nvl(sum(case when to_date(vencimiento,'yyyymmdd')<trunc(sysdate) then ROUND (saldo / 100, 2) end ),0)SaldoVencido,
                              to_date(vencimiento,'yyyymmdd') ohduedate,
                              vciclofact
                            /*from table(getFacturasPisa2('22380328', '03'))*/
                            from table(getFacturasPisa2({CLIENTE}, '03'))
                            where substr(telefono,11,1)=0
                        group by
                            telefono,
                            nombre,
                            to_char(to_date(fecha,'yyyymmdd'),'dd/MM/yyyy'),
                            to_char(to_date(vencimiento,'yyyymmdd'),'dd/MM/yyyy'),
                            nvl(Round((trunc(sysdate) - to_date(vencimiento,'yyyymmdd')),0),0),
                            to_date(vencimiento,'yyyymmdd'),
                            vciclofact
                    ) datos
    ]]></query_cliente>




    <query_telefono><![CDATA[
                select
                    row_number() over ( partition by customer_id order by customer_id, ohduedate desc) No,
                    datos.customer_id, datos.co_id, datos.dn_num, datos.nombre, datos.identificacion, datos.tipo_cliente, datos.correo,
                    sum(nvl(saldoNoVencido,0)+nvl(saldovencido,0)) over ( partition by customer_id order by customer_id) saldo_total,
                    sum(saldoNoVencido) over ( partition by customer_id order by customer_id) saldo_novencido,
                    sum(saldovencido) over ( partition by customer_id order by customer_id) saldo_vencido,
                    count(*) over ( partition by customer_id order by customer_id) cantidad_documentos,
                    datos.id2, datos.docid, datos.doc, datos.refe, datos.npe, datos.lectura, datos.factura, datos.emision, datos.vencimiento, datos.diasmora, datos.saldo, datos.saldovencido, datos.saldoNovencido, datos.ohduedate,
                    vciclofact ciclo
                    from (
                        SELECT
                              telefono customer_id           ,
                              '' co_id                 ,
                              substr(telefono,3,8) dn_num                ,
                              nombre                         ,
                              '' Identificacion                 ,
                              '' Tipo_Cliente,
                              '' Correo,
                              nvl(sum(case when ROUND (saldo_servicio, 2)>0 then ROUND (saldo_servicio, 2) end),0)                 Saldo_total,
                              nvl(sum(case when to_date(vencimiento,'yyyymmdd')<trunc(sysdate) then ROUND (saldo_servicio, 2) end),0)    Saldo_Vencido,
                              nvl(count(*) -1 ,0)                                                  Cantidad_Documentos ,
                              telefono              id2,
                              telefono  || '-' || TO_CHAR (sID)            docid,
                              ''                    doc,
                              telefono  || '-' || TO_CHAR (sID)            refe,
                              ''                    npe,
                              0                     Lectura,
                              'FA'                  Factura,
                              to_char(fecha,'dd/MM/yyyy')             Emision,
                              to_char(vencimiento,'dd/MM/yyyy')                   Vencimiento,
                              nvl(Round((trunc(sysdate) - vencimiento),0),0)      diasMora,
                              nvl(sum(case when ROUND (saldo_servicio, 2)>0 then ROUND (saldo_servicio, 2) end),0)  Saldo,
                              nvl(sum(case when vencimiento>=trunc(sysdate) then ROUND (saldo_servicio , 2) end ),0)SaldoNoVencido,
                              nvl(sum(case when vencimiento<trunc(sysdate) then ROUND (saldo_servicio, 2) end ),0)SaldoVencido,
                              vencimiento ohduedate,
                              vciclofact
                            /*from table(getFacturasPisa2('22380328', '03'))*/
                            from (
                                    select telefono, fecha, nombre, rownum sID,vencimiento, saldo_servicio, vciclofact FROM
                                    (
                                    SELECT  telefono, to_date(fecha,'yyyy/MM/dd') fecha,nombre,
                                            DECODE (vencimiento, '00000000', TRUNC (SYSDATE) - 30, TO_DATE (vencimiento, 'yyyy/mm/dd') - 30) vencimiento,
                                            ABS (ROUND ( (pagos - adeudo) / 100, 2)) saldo_servicio,
                                            vciclofact
                                    FROM (SELECT * FROM TABLE (getFacturasPisa2 ({TELEFONO}, '03'))) a
                                    WHERE ROUND ( (pagos - adeudo) / 100, 2) < 0 AND telefono = '00'||{TELEFONO}||'0' AND adeudo > 0 AND saldo > 0
                                    UNION ALL
                                    SELECT  telefono ,to_date(fecha,'yyyy/MM/dd') fecha,nombre,
                                            DECODE (vencimiento, '00000000', TRUNC (SYSDATE), TO_DATE (vencimiento, 'yyyy/mm/dd')) vencimiento,
                                            (CASE WHEN adeudo > 0 AND adeudo > pagos THEN ROUND ( (saldo - ABS (pagos - adeudo)) / 100, 2) ELSE ROUND (saldo / 100, 2) END) saldo_servicio,
                                            vciclofact
                                    FROM (SELECT * FROM TABLE (getFacturasPisa2 ({TELEFONO}, '03'))) a
                                    WHERE ROUND ( (saldo - (pagos - (adeudo + RENTA + OTROSCARGOS + LARGADISTISTANCIA + SERVICIOMEDIDO + AJUSTES + IVA))) / 100, 2) > 0
                                    AND telefono = '00'||{TELEFONO}||'0' AND saldo > 0
                                    UNION ALL
                                    SELECT  telefono,to_date(fecha,'yyyy/MM/dd') fecha,nombre,
                                            DECODE (vencimiento, '00000000', TRUNC (SYSDATE), TO_DATE (vencimiento, 'yyyy/mm/dd')) vencimiento,
                                            ROUND (saldo / 100, 2) saldo_servicio,
                                            vciclofact
                                    FROM (SELECT * FROM TABLE (getFacturasPisa2 ({TELEFONO}, '03'))) a
                                    WHERE telefono = '00'||{TELEFONO}||'0' AND saldo <= 0
                                    ) SUBDATA
                                ) data
                        group by
                            telefono, telefono || '-' || TO_CHAR (sID),
                            nombre,
                            to_char(fecha,'dd/MM/yyyy'),
                            to_char(vencimiento,'dd/MM/yyyy'),
                            nvl(Round((trunc(sysdate) - vencimiento),0),0),
                            vencimiento,
                            vciclofact
                    ) datos
    ]]></query_telefono>


</root>