<?xml version="1.0" encoding="ISO-8859-1"?>
<root>
    <query_cliente  ><![CDATA[
                select
                    row_number() over ( partition by customer_id order by customer_id, ohduedate desc) No,
                    datos.customer_id, datos.co_id, datos.dn_num, datos.nombre, datos.identificacion, datos.tipo_cliente, datos.correo,
                    sum(nvl(saldoNoVencido,0)+nvl(saldovencido,0)) over ( partition by customer_id order by customer_id) saldo_total,
                    sum(saldoNoVencido) over ( partition by customer_id order by customer_id) saldo_novencido,
                    sum(saldovencido) over ( partition by customer_id order by customer_id) saldo_vencido,
                    count(*) over ( partition by customer_id order by customer_id) cantidad_documentos,
                    datos.id2, datos.docid, datos.doc, datos.refe, datos.npe, datos.lectura, datos.factura, datos.emision, datos.vencimiento, datos.diasmora, datos.saldo, datos.saldovencido, datos.saldoNovencido, datos.ohduedate,
                    (SELECT id_ciclo FROM smart.vwinvoiceswithbalance2@open_nica WHERE contrato = datos.customer_id AND ROWNUM = 1) ciclo
                    from (
                        SELECT
                              contrato customer_id           ,
                              '' co_id                 ,
                              '' dn_num                ,
                              nombre                         ,
                              '' Identificacion                 ,
                              '' Tipo_Cliente,
                              '' Correo,
                              nvl(sum(case when vlrapagar>0 then vlrapagar end),0)                 Saldo_total,
                              nvl(sum(case when fechavcto<trunc(sysdate) then vlrapagar end),0)    Saldo_Vencido,
                              nvl(count(*) -1 ,0)                                                  Cantidad_Documentos ,
                              contrato              id2,
                              case when vlrapagar>0 then facturainterna end              docid,
                              ''                    doc,
                              case when vlrapagar>0 then vlrcupon end              refe,
                              ''                    npe,
                              0                     Lectura,
                              'FA'                  Factura,
                              to_char(fechageneracion,'dd/MM/yyyy')             Emision,
                              to_char(fechavcto,'dd/MM/yyyy')                   Vencimiento,
                              nvl(Round((trunc(sysdate) - fechavcto),0),0)      diasMora,
                              nvl(sum(case when vlrapagar>0 then vlrapagar end),0)  Saldo,
                              nvl(sum(case when fechavcto>=trunc(sysdate) then vlrapagar end ),0)SaldoNoVencido,
                              nvl(sum(case when fechavcto<trunc(sysdate) then vlrapagar end ),0)SaldoVencido,
                              fechavcto ohduedate
                            FROM (
                                SELECT distinct contrato, nombre, facturainterna, vlrcupon, vlrapagar, fechavcto, fechageneracion, numerofiscalfactura, id_ciclo, empresa, tipo_cupon
                                from smart.eni_vwinvoicebalancebycontrato@open_nica
                                WHERE smart.eni_pkg_invoices_with_balance.setdatabycontrato@open_nica({CLIENTE} ) =1
                                AND id_ciclo IN  (select  COLUMN_VALUE from    table(split(get_parametro('CICLO'),',')))
                                AND vlrapagar >= 0
                            ) DATOS
                        group by
                            contrato,
                            nombre,
                            vlrcupon,
                            facturainterna,
                            to_char(fechageneracion,'dd/MM/yyyy'),
                            to_char(fechavcto,'dd/MM/yyyy'),
                            nvl(Round((trunc(sysdate) - fechavcto),0),0),
                            fechavcto,case when vlrapagar>0 then facturainterna end,case when vlrapagar>0 then vlrcupon end
                    ) datos
    ]]></query_cliente>




    <query_telefono><![CDATA[
                select
                    row_number() over ( partition by customer_id order by customer_id, ohduedate desc) No,
                    datos.customer_id, datos.co_id, datos.dn_num, datos.nombre, datos.identificacion, datos.tipo_cliente, datos.correo,
                    sum(nvl(saldoNoVencido,0)+nvl(saldovencido,0)) over ( partition by customer_id order by customer_id) saldo_total,
                    sum(saldoNoVencido) over ( partition by customer_id order by customer_id) saldo_novencido,
                    sum(saldovencido) over ( partition by customer_id order by customer_id) saldo_vencido,
                    count(*) over ( partition by customer_id order by customer_id) cantidad_documentos,
                    datos.id2, datos.docid, datos.doc, datos.refe, datos.npe, datos.lectura, datos.factura, datos.emision, datos.vencimiento, datos.diasmora, datos.saldo, datos.saldovencido, datos.saldoNovencido, datos.ohduedate,
                    (SELECT id_ciclo FROM smart.vwinvoiceswithbalance2@open_nica WHERE contrato = datos.customer_id AND ROWNUM = 1) ciclo
                    from (
                        SELECT
                              contrato customer_id           ,
                              '' co_id                 ,
                              '' dn_num                ,
                              nombre                         ,
                              '' Identificacion                 ,
                              '' Tipo_Cliente,
                              '' Correo,
                              nvl(sum(case when vlrapagar>0 then vlrapagar end),0)                 Saldo_total,
                              nvl(sum(case when fechavcto<trunc(sysdate) then vlrapagar end),0)    Saldo_Vencido,
                              nvl(count(*) -1 ,0)                                                  Cantidad_Documentos ,
                              contrato              id2,
                              case when vlrapagar>0 then vlrcupon       end        docid,
                              ''                    doc,
                              case when vlrapagar>0 then facturainterna end        refe,
                              ''                    npe,
                              0                     Lectura,
                              'FA'                  Factura,
                              to_char(fechageneracion,'dd/MM/yyyy')             Emision,
                              to_char(fechavcto,'dd/MM/yyyy')                   Vencimiento,
                              nvl(Round((trunc(sysdate) - fechavcto),0),0)      diasMora,
                              nvl(sum(case when vlrapagar>0 then vlrapagar end),0)  Saldo,
                              nvl(sum(case when fechavcto>=trunc(sysdate) then vlrapagar end ),0)SaldoNoVencido,
                              nvl(sum(case when fechavcto<trunc(sysdate) then vlrapagar end ),0)SaldoVencido,
                              fechavcto ohduedate
                            FROM (
                                SELECT distinct contrato, nombre, facturainterna, vlrcupon, vlrapagar, fechavcto, fechageneracion, numerofiscalfactura, id_ciclo, empresa, tipo_cupon
                                from smart.eni_vwinvoicebalancebycontrato@open_nica
                                WHERE smart.eni_pkg_invoices_with_balance.setdatabyphone@open_nica ({TELEFONO}) = 1
                                AND NVL (id_ciclo, 55) IN (select  COLUMN_VALUE from    table(split(get_parametro('CICLO'),','))) ;
                                AND vlrapagar >= 0
                            ) DATOS
                        group by
                            contrato,
                            nombre,
                            vlrcupon,
                            facturainterna,
                            to_char(fechageneracion,'dd/MM/yyyy'),
                            to_char(fechavcto,'dd/MM/yyyy'),
                            nvl(Round((trunc(sysdate) - fechavcto),0),0),
                            fechavcto,case when vlrapagar>0 then facturainterna end,case when vlrapagar>0 then vlrcupon end
                    ) datos
    ]]></query_telefono>


</root>