<?xml version="1.0" encoding="ISO-8859-1"?>
<root>
    <query  ><![CDATA[
      select
                  row_number() over ( partition by customer_id order by customer_id, ohduedate desc) No,
                  datos.customer_id, datos.co_id, datos.dn_num, datos.nombre, datos.identificacion, datos.tipo_cliente, datos.correo,
                  sum(nvl(saldoNoVencido,0)+nvl(saldovencido,0)) over ( partition by customer_id order by customer_id) saldo_total,
                  sum(saldoNoVencido) over ( partition by customer_id order by customer_id) saldo_novencido,
                  sum(saldovencido) over ( partition by customer_id order by customer_id) saldo_vencido,
                  count(*) over ( partition by customer_id order by customer_id) cantidad_documentos,
                  datos.id2, datos.docid, datos.doc, datos.refe, datos.npe, datos.lectura, datos.factura, datos.emision, datos.vencimiento, datos.diasmora, datos.saldo, datos.saldovencido , datos.saldoNovencido,  datos.ohduedate,
                  ( select Billcycle from customer_bch where customer_id=datos.customer_id ) Ciclo
                  from
                  (
                  select
                      case when H1.customer_id = a.customer_id and h1.customer_id is not null then a.customer_id else nvl(a.customer_id_high,a.customer_id) end customer_id           ,
                      e.co_id                 ,
                      g.dn_num                ,
                      concat(concat(c.ccname || ' ',c.ccfname || ' '),c.cclname)  nombre,
                      c.passportno              Identificacion,
                      nvl(b.prgname,'-') Tipo_Cliente,
                      ccemail                 Correo,
                      nvl(sum(case when ohopnamt_doc>0 then round(ohopnamt_doc,2) end),0)                         Saldo_total,
                      nvl(sum(case when ohduedate<trunc(sysdate) then round(ohopnamt_doc,2) end),0)               Saldo_Vencido,
                      nvl(count(*) -1 ,0)                                                                Cantidad_Documentos ,
                      h.customer_id           id2,
                      h.ohxact                docid,
                      ''                      doc,
                      h.ohrefnum              refe,
                      ''                      npe,
                      0                      Lectura,
                      'FA'                    Factura,
                      to_char(h.ohentdate,'dd/MM/yyyy')        Emision,
                      to_char(h.ohduedate,'dd/MM/yyyy')        Vencimiento,
                      nvl(Round((trunc(sysdate) - h.ohduedate),0),0)  diasMora,
                      nvl(sum(case when ohopnamt_doc>0 then round(ohopnamt_doc,2) end),0)  Saldo,
                      nvl(sum(case when ohduedate>=trunc(sysdate) then round(ohopnamt_doc,2) end ),0)SaldoNoVencido,
                      nvl(sum(case when ohduedate<trunc(sysdate) then round(ohopnamt_doc,2) end ),0)SaldoVencido,
                      ohduedate
                  from Customer_all a
                          inner join PriceGroup_all   b on b.prgcode     = a.prgcode
                          inner join Ccontact_all     c on c.customer_id = a.customer_id and c.ccseq       > 0 and c.ccseq  = (select max(x.ccseq) from ccontact_all x where c.customer_id = x.customer_id and ccbill = 'X') and c.ccbill = 'X'
                          left outer join Trade_all   d on d.tradecode = a.cstradecode
                          left outer join  Contract_all    e on e.customer_id = a.customer_id and nvl(e.plcode,1709)      = 1709	/*Movil*/
                          left outer join Contr_services_cap f on  f.co_id    = e.co_id and f.dn_id is not null and f.cs_deactiv_date is null
                          left outer join directory_number g on g.dn_id       = f.dn_id
                          left outer join orderhdr_all h on h.customer_id = a.customer_id and h.ohstatus in ('FS','CS','IN', 'FE') and nvl(h.ohopnamt_doc,0)>0
                          left outer join billing_account H1 on H1.customer_id = a.customer_id
                          left outer join billing_account H2 on H2.customer_id = a.customer_id_high
                  where
                      {} /*g.dn_num='50762254307'*/
                  group by
                      case when H1.customer_id = a.customer_id and h1.customer_id is not null then a.customer_id else nvl(a.customer_id_high,a.customer_id) end           ,
                      e.co_id                 ,
                      g.dn_num                ,
                      concat(concat(c.ccname || ' ',c.ccfname || ' '),c.cclname)  ,
                      c.passportno            ,
                      nvl(b.prgname,'-')      ,
                      ccemail                 ,
                      h.customer_id           ,
                      h.ohxact                ,
                      ''                      ,
                      h.ohrefnum              ,
                      to_char(h.ohentdate,'dd/MM/yyyy')        ,
                      to_char(h.ohduedate,'dd/MM/yyyy')        ,
                      Round((trunc(sysdate) - h.ohduedate),0)  ,
                      ohduedate
                   ) datos
                   order by to_date(vencimiento,'dd/MM/yyyy') asc
    ]]></query>
</root>